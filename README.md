See pdf for implementation details.
